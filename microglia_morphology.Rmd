---
title: "Microglial morphology"
author: "Bindoff, A."
output: html_document
---

`r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)
```

```{r}
library(readr)
library(dplyr)
library(lme4)
library(car)
library(ggplot2)
library(ggiraph)
library(ggiraphExtra)

df <- read_csv("MicroglialMorphology.csv")
#View(df)
df <- na.omit(df)
df$agemonth <- factor(df$agemonth)

overdisp_fun <- function(model) {
  ## number of variance parameters in 
  ##   an n-by-n variance-covariance matrix
  vpars <- function(m) {
    nrow(m)*(nrow(m)+1)/2
  }
  model.df <- sum(sapply(VarCorr(model),vpars))+length(fixef(model))
  rdf <- nrow(model.frame(model))-model.df
  rp <- residuals(model,type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

xtabs(~agemonth + strain, df)
xtabs(~plaque + strain, df)
xtabs(~location + strain, df)
```

For each cell morphology, a generalised linear mixed model was fitted with the proportion of cells with that morphology as the response variable, and location, strain, age, and strain x age interaction as predictors. Section was nested within animal as the random effects term. This is a random effect because sections are taken from animals which are drawn from a population, and the effect of each individual animal is random (not assigned or controlled). In each case, a violin plot is drawn. The bars show estimated mean and 95% CI. Data points are overlaid.


### Ramified

```{r}
ggplot(df, aes(x = strain, y = ramified, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
  geom_dotplot(binaxis='y', stackdir='center',
               position = "dodge",
               aes(fill = agemonth),
               dotsize = 3/5, alpha = 1/2) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

ram <-
          glmer(cbind(ramified, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")
Anova(ram, type = 3)
k <- summary(ram)
```
  
### Hyper-ramified

```{r}
ggplot(df, aes(x = strain, y = hyperamified, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
  geom_dotplot(binaxis='y', stackdir='center',
               position = "dodge",
               aes(fill = agemonth),
               dotsize = 3/5, alpha = 1/2) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

hyper <- glmer(cbind(hyperamified, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")
Anova(hyper, type = 3)
```

  
### Amoeboid

```{r, warning = T}
ggplot(df, aes(x = strain, y = amoeboid, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

amoeboid1 <- glmer(cbind(amoeboid, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")
# summary(am <- glmer.nb(amoeboid/totalcells ~ location + strain*agemonth + (1|animal/section), data = df))
```

The summary for this model includes a warning, and does not give much evidence for an interaction. We fit the model again without an interaction.

```{r}
amoeboid2 <- glmer(cbind(amoeboid, totalcells) ~ location + strain +agemonth + (1|animal/section),
                      data = df, family = "binomial")
anova(amoeboid1, amoeboid2)
```

A likelihood-ratio test (LRT) tells us that the models are equivalent (Pr(>Chisq) > .05), so there is no evidence to include the interaction term.  We report these null results, and the results of the model without the interaction term.

```{r}
Anova(amoeboid2, type = 3)
```


### Rod

```{r}
ggplot(df, aes(x = strain, y = rod, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
   theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

rod1 <- glmer(cbind(rod, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")

Anova(rod1, type = 3)

```

### Filtering on "plaque = no"

### Ramified - no plaque

```{r}
df0 <- df
df <- dplyr::filter(df, plaque == "no")
ggplot(df, aes(x = strain, y = ramified, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
  geom_dotplot(binaxis='y', stackdir='center',
               position = "dodge",
               aes(fill = agemonth),
               dotsize = 3/5, alpha = 1/2) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

ram <- glmer(cbind(ramified, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")
Anova(ram, type = 3)
```
  
### Hyper-ramified - no plaque

```{r}
ggplot(df, aes(x = strain, y = hyperamified, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
  geom_dotplot(binaxis='y', stackdir='center',
               position = "dodge",
               aes(fill = agemonth),
               dotsize = 3/5, alpha = 1/2) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

hyper <- glmer(cbind(hyperamified, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")
Anova(hyper, type = 3)
```

  
### Amoeboid - no plaque

```{r, warning = T}
ggplot(df, aes(x = strain, y = amoeboid, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

amoeboid1 <- glmer(cbind(amoeboid, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")
# summary(am <- glmer.nb(amoeboid/totalcells ~ location + strain*agemonth + (1|animal/section), data = df))
```

The summary for this model includes a warning, and does not give much evidence for an interaction. We fit the model again without an interaction.

```{r}
amoeboid2 <- glmer(cbind(amoeboid, totalcells) ~ location + strain +agemonth + (1|animal/section),
                      data = df, family = "binomial")
anova(amoeboid1, amoeboid2)
```

A likelihood-ratio test (LRT) tells us that the models are equivalent (Pr(>Chisq) > .05), so there is no evidence to include the interaction term.  We report these null results, and the results of the model without the interaction term.

```{r}
Anova(amoeboid2, type = 3)
```


### Rod

```{r}
ggplot(df, aes(x = strain, y = rod, colour = agemonth)) +
  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.1) +
   theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) 

rod1 <- glmer(cbind(rod, totalcells) ~ location + strain*agemonth + (1|animal/section),
                data = df, family = "binomial")

Anova(rod1, type = 3)

```

### Suggestions

Location:  this rings some pretty big alarm bells - what does it really signify? There were no plaques in wt mice. I'm not sure how to interpret the effect of location. This is why I ran a sub-analysis taking out "plaque = 'yes'" mice.

Interaction terms:  where there is a significant interaction, you should **not** interpret the main effects strain and age, even if significant.  For the amoeboid morphologies, you can only interpret the main effects. So this means that the effect of age must be averaged over strain, and the effect of strain must be averaged over age.

Plots:  tell me what you want. I like the stacked dot plots for this sort of count data, but they don't really work when you've got a lot of zeros (they all run into each other) - hence the violin plots. However...

Because each section has a distribution of morphologies, I think plotting in a way that highlights these differences is useful:

```{r}
df.r <- select(df0, strain, agemonth, ramified, hyperamified, amoeboid, rod, totalcells) %>%
  transmute(strain = strain,
            agemonth = agemonth,
            ramified = ramified/totalcells,
            hyperamified = hyperamified/totalcells,
            amoeboid = amoeboid/totalcells,
            rod = rod/totalcells)

ggRadar(data = data.frame(df.r), aes(group = agemonth))
ggRadar(data = data.frame(df.r), aes(group = strain))



```

Descriptive statistics:  let's have a talk about how we deal with the location and plaque issues before we look at this.